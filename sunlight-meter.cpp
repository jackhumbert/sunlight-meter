#include <stdint.h>
#include <stdlib.h>
#include <stdio.h>
#include <avr/pgmspace.h>
#include <avr/io.h>
#include <avr/interrupt.h>
#include "Framebuffer.h"
extern "C" {
	#include "analog.h"
}
const uint8_t image[] PROGMEM = {
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff
,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff
,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff
,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff
,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff
,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff
,0xff,0x07,0x01,0xc1,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff
,0xff,0xc7,0xc7,0xc7,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff
,0xff,0xc7,0xc7,0xc7,0xf9,0xd6,0xbe,0xdb,0xad,0xdb,0xb9,0xff,0xff,0xff,0xff,0xff
,0xff,0xc7,0xc7,0xc7,0xf6,0xaa,0xbd,0x55,0x55,0x55,0x57,0xff,0xff,0xff,0xff,0xff
,0xff,0xc7,0xc7,0xc7,0xf6,0xaa,0x7d,0xd7,0x55,0x51,0x73,0xff,0xff,0xff,0xff,0xff
,0xff,0xc7,0xc7,0xc7,0xf6,0xaa,0xbc,0xd7,0x55,0x55,0x77,0xff,0xff,0xff,0xff,0xff
,0xff,0xc7,0xc7,0xc7,0xf5,0xaa,0xbd,0xd7,0x55,0x55,0x77,0xff,0xff,0xff,0xff,0xff
,0xff,0xc7,0xc7,0xc7,0xfa,0xba,0xbd,0xd7,0x76,0xb5,0x79,0xff,0xff,0xff,0xff,0xff
,0xff,0xe7,0xc7,0xcf,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff
,0xff,0xe3,0xc7,0x8f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff
,0xff,0xf1,0xc7,0x1f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff
,0xff,0xfc,0x00,0x7f,0xfb,0xba,0xeb,0x5b,0x6d,0x7c,0xad,0xdd,0xdd,0xc9,0xff,0xff
,0xff,0xff,0xc7,0xff,0xf5,0x55,0x55,0x55,0x45,0x7b,0xaa,0xaa,0xa8,0xba,0xff,0xff
,0xff,0xff,0xc7,0xff,0xf7,0x55,0x55,0x55,0x6d,0x4d,0xaa,0xaa,0xbd,0x9a,0xff,0xff
,0xff,0xff,0xc7,0xff,0xf7,0x55,0x55,0x55,0x6d,0x7e,0xa9,0x9a,0xbd,0xba,0xff,0xff
,0xff,0xff,0xc7,0xff,0xf5,0x55,0x55,0x55,0x6d,0x7e,0xab,0xba,0xbd,0xba,0xff,0xff
,0xff,0xff,0xc7,0xff,0xfb,0xb7,0x5d,0xb5,0x76,0xf9,0xdb,0xbd,0xbe,0xc9,0xff,0xff
,0xff,0xff,0xc7,0xff,0xff,0xff,0xff,0xff,0xfd,0xff,0xff,0xff,0xff,0xff,0xff,0xff
,0xff,0xff,0x01,0xff,0xff,0xff,0xff,0xff,0xfb,0xff,0xff,0xff,0xff,0xff,0xff,0xff
,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff
,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff
,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff
,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff
,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff
,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff
,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff

};


uint16_t min_sunlight, max_sunlight, sunlight;

Framebuffer fb;

uint16_t second_data[60];
uint16_t minute_data[60];
uint16_t hour_data[24];

uint8_t seconds, minutes, hours;
double sunlight_sum, hour_sum, minute_sum, second_sum, average_sunlight;

char sunlight_string[32], average_string[32];

int main(void) {

    fb.drawBitmap(image,64,128,0,0);
    fb.show();

	DDRD |= (1<<6);
	PORTD |= (1<<6);

	sunlight = 0;
	seconds = 0;
	minutes = 0;
	hours = 0;

	cli();
	TCNT1 = 0x0000; // reset counter to 0 at start
	TCCR1A= 0b00000000; // turn off PWM
	TCCR1B= 0b00001100; // set CTC on and prescalar to /256
	TIMSK1 |= _BV(OCIE1A); // enable timer compare A interrupt
	//OCR1A = 31249; //set the comparator A to trigger at 1 second
	OCR1A = (3125 * 2) - 1;
	sei();


	DDRD |= (1<<6);
	PORTD &= ~(1<<6);

	min_sunlight = max_sunlight = sunlight = analogRead(3);

    while (true) {
	}
    return 0;
}

inline uint16_t min(uint16_t a, uint16_t b) {
    if (a > b)
        return b;
    return a;
}

inline uint16_t max(uint16_t a, uint16_t b) {
    if (a < b)
        return b;
    return a;
}

ISR(TIMER1_COMPA_vect) {
	sunlight = analogRead(3);
	min_sunlight = min(min_sunlight, sunlight);
	max_sunlight = max(max_sunlight, sunlight);

	second_data[seconds] = sunlight;
	seconds++;
	if (seconds == 60) {
		sunlight_sum = 0;
		for (int i = 0; i < 60; i++) {
			sunlight_sum += second_data[i];
		}
		minute_data[minutes] = sunlight_sum / 60.0;
		minutes++;
	}
	if (minutes == 60) {
		sunlight_sum = 0;
		for (int i = 0; i < 60; i++) {
			sunlight_sum += minute_data[i];
		}
		hour_data[hours] = sunlight_sum / 60.0;
		hours++;
	}
	seconds %= 60;
	hours %= 24;
	minutes %= 60;

	hour_sum = 0;
	for (int i = 0; i < hours; i++) {
		hour_sum += hour_data[i];
	}
	minute_sum = 0;
	for (int i = 0; i < minutes; i++) {
		minute_sum += minute_data[i];
	}
	second_sum = 0;
	for (int i = 0; i < seconds; i++) {
		second_sum += second_data[i];
	}
	if (hours > 0) {
		hour_sum *= (1.0 / hours);
		minute_sum *= (1.0 / 60.0);
		second_sum *= (1.0 / 60.0 / 60.0);
	}
	if (minutes > 0) {
		hour_sum *= (59.0 / 60.0);
		minute_sum *= (1.0 / minutes);
		if (hours == 0)
			second_sum *= (1.0 / 60);
	}
	if (seconds > 0) {
		hour_sum *= (59.0 / 60.0);
		minute_sum *= (59.0 / 60.0);
		second_sum *= (1.0 / seconds);
	}
	average_sunlight = hour_sum + minute_sum + second_sum;

	fb.clear();
    fb.drawRectangle(0, 26, (1.0 * sunlight - min_sunlight) / ( 1.0 * max_sunlight - min_sunlight) * 128.0, 29, 1);
    fb.drawVLineInverse((1.0 * average_sunlight - min_sunlight) / (1.0 * max_sunlight - min_sunlight) * 128.0, 24, 8);
    fb.drawVLine(0, 24, 8);
    //fb.drawHLineInverse(min_sunlight/8+1, 31, 1);
    fb.drawVLineInverse(127, 24, 8);
    //fb.drawHLineInverse(max_sunlight/8-1, 24, 1);
    sprintf(sunlight_string, "Cur: %-4d    %02d:%02d:%02d", sunlight, hours, minutes, seconds);
    sprintf(average_string, "%-4d     %-4.0f    %4d", min_sunlight, average_sunlight, max_sunlight);
    fb.drawString(sunlight_string, 0, 0);
    fb.drawString(average_string, 0, 12);
    fb.show();
}